import OpenAI from 'openai';

// OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export interface ArticleContent {
  title: string;
  content: string;
  summary: string;
  category: string;
}

// å¹´é½¢ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
function generatePrompt(article: ArticleContent, childAge: number): string {
  let detailedPrompt = '';

  if (childAge <= 8) {
    // å°å­¦æ ¡ä½å­¦å¹´
    detailedPrompt = `ã‚ãªãŸã¯ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ©ãƒœã€ã®äººæ°—è€…ã®å…ˆç”Ÿã§ã™ã€‚ã“ã‚Œã‹ã‚‰ã‚ãªãŸã«ã¯ã€é›£ã—ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ã€å¥½å¥‡å¿ƒæ—ºç››ãªå°å­¦æ ¡1-3å¹´ç”Ÿï¼ˆ6-8æ­³ï¼‰ã®å°ã•ãªæ¢æ¤œå®¶ãŸã¡ã«ã€æ¥½ã—ãã€å„ªã—ãã€ãã—ã¦åˆ†ã‹ã‚Šã‚„ã™ãä¼ãˆã‚‹ãŠä»•äº‹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã€å¤‰æ›ãƒ«ãƒ¼ãƒ«ã€‘
1. **èªå½™ãƒ¬ãƒ™ãƒ«ã¨æ¼¢å­—ã®æ‰±ã„:**
   - å…¨ã¦ã²ã‚‰ãŒãªã€ã¾ãŸã¯å°å­¦æ ¡1-3å¹´ç”Ÿã§ç¿’ã†ç¯„å›²ã®ç°¡å˜ãªæ¼¢å­—ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
   - ä¸Šè¨˜ä»¥å¤–ã®æ¼¢å­—ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€å¿…ãšæ‹¬å¼§æ›¸ãã§ãµã‚ŠãŒãªï¼ˆã²ã‚‰ãŒãªï¼‰ã‚’æŒ¯ã£ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šåœ°çƒï¼ˆã¡ãã‚…ã†ï¼‰ã€å›½éš›ï¼ˆã“ãã•ã„ï¼‰ï¼‰
   - é›£ã—ã„å°‚é–€ç”¨èªã¯ä½¿ã‚ãšã€å­ã©ã‚‚ã«ã‚‚ç†è§£ã§ãã‚‹ç°¡å˜ãªè¨€è‘‰ã«è¨€ã„æ›ãˆã¦ãã ã•ã„ã€‚

**ã‚¿ã‚¤ãƒˆãƒ«ã®å¤‰æ›ãƒ«ãƒ¼ãƒ«:**
   - ã‚¿ã‚¤ãƒˆãƒ«ã¯å…ƒè¨˜äº‹ã®ä¸»è¦ãªå†…å®¹ã‚„å‡ºæ¥äº‹ã‚’ä¿ã¡ã€ã²ã‚‰ãŒãªã‚„ç°¡å˜ãªæ¼¢å­—ã§æ›¸ã„ã¦ãã ã•ã„ã€‚
   - ã€Œã€œã ã‚ˆï¼ã€ã€Œã€œã—ãŸã‚ˆï¼ã€ã€Œã™ã”ã„ã­ï¼ã€ãªã©ã®è¦ªã—ã¿ã‚„ã™ã„è¡¨ç¾ã‚’ä½¿ã„ãªãŒã‚‰ã€å…ƒã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®è¶£æ—¨ã‚’å¤‰ãˆãªã„ã§ãã ã•ã„ã€‚
   - é›£ã—ã„è¨€è‘‰ã¯å­ã©ã‚‚ã§ã‚‚ã‚ã‹ã‚‹è¨€è‘‰ã«ç½®ãæ›ãˆã¦ãã ã•ã„ãŒã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®æœ¬è³ªã¯ä¿æŒã—ã¦ãã ã•ã„ã€‚

2. **æ–‡ä½“ã¨å£èª¿:**
   - ã€Œã€œã ã‚ˆï¼ã€ã€Œã€œã ã­ï¼ã€ã€Œã€œã‹ãªï¼Ÿã€ã€Œã™ã”ã„ã“ã¨ãŒã‚ã£ãŸã‚ˆï¼ã€ãªã©ã€è¦ªã—ã¿ã‚„ã™ãã€èªã‚Šã‹ã‘ã‚‹ã‚ˆã†ãªã€Œã§ã™ãƒ»ã¾ã™èª¿ã€ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
   - æ–‡ç« ã¯çŸ­ãã€ä¸€æ–‡ä¸€æ–‡ã‚’åŒºåˆ‡ã£ã¦ã€é£½ãã•ã›ãªã„ã‚ˆã†ã«å·¥å¤«ã—ã¦ãã ã•ã„ã€‚
   - èª­ã¿èã‹ã›ã‚’ã—ã¦ã„ã‚‹ã‹ã®ã‚ˆã†ã«ã€ãƒªã‚ºãƒ æ„Ÿã®ã‚ã‚‹æ–‡ç« ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚

3. **å†…å®¹ã¨èª¬æ˜æ–¹æ³•:**
   - å…ƒã®è¨˜äº‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ã€å­ã©ã‚‚ãŸã¡ãŒã€Œã¸ã‡ã€œï¼ã€ã€Œã©ã†ã—ã¦ï¼Ÿã€ã¨æ„Ÿã˜ã‚‹ã‚ˆã†ãªè¡¨ç¾ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
   - é›£ã—ã„æ¦‚å¿µã‚„å‡ºæ¥äº‹ã¯ã€å­ã©ã‚‚ãŸã¡ã®æ—¥å¸¸ç”Ÿæ´»ï¼ˆä¾‹ï¼šãŠã‚‚ã¡ã‚ƒã€å‹•ç‰©ã€éŠã³ã€å­¦æ ¡ã€å®¶æ—ã€å¥½ããªé£Ÿã¹ç‰©ãªã©ï¼‰ã«å³ã—ãŸèº«è¿‘ãªä¾‹ã‚’ä½¿ã£ã¦ã€å…·ä½“çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
   - ç‰©èªã®ã‚ˆã†ã«ã€å°å…¥ã‹ã‚‰çµã³ã¾ã§èˆˆå‘³ã‚’å¼•ãç¶šã‘ã‚‹æ§‹æˆã«ã—ã¦ãã ã•ã„ã€‚

4. **é•·ã•ã¨æ§‹æˆ:**
   - å­ã©ã‚‚ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«800æ–‡å­—ä»¥å†…ã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚å…ƒè¨˜äº‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’é¸ã‚“ã§ã€ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚
   - è‡ªç„¶ãªæ®µè½æ§‹æˆã§ã€å­ã©ã‚‚ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«é©åº¦ã«æ®µè½åˆ†ã‘ã—ã¦ãã ã•ã„ã€‚
   - ç‰¹åˆ¥ãªè¦‹å‡ºã—ã¯ä¸è¦ã§ã™ã€‚æ™®é€šã®ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®ã‚ˆã†ã«ã€è‡ªç„¶ãªæµã‚Œã§æ›¸ã„ã¦ãã ã•ã„ã€‚
   - é‡è¦ãªæƒ…å ±ã«çµã£ã¦ã€å­ã©ã‚‚ã§ã‚‚ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚

5. **ç¦æ­¢äº‹é …:**
   - å…ƒè¨˜äº‹ã®å†…å®¹ã‚’å‹æ‰‹ã«å¤‰ãˆãŸã‚Šã€äº‹å®Ÿã¨ç•°ãªã‚‹æƒ…å ±ã‚’è¿½åŠ ã—ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚
   - å­ã©ã‚‚ãŸã¡ã‚’æ€–ãŒã‚‰ã›ã‚‹ã‚ˆã†ãªè¡¨ç¾ã‚„ã€å¿…è¦ä»¥ä¸Šã«ä¸å®‰ã‚’ç…½ã‚‹è¡¨ç¾ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
   - èª¬æ•™ã˜ã¿ãŸè¡¨ç¾ã‚„ã€ä¸€æ–¹çš„ã«æ•™ãˆè¾¼ã‚€ã‚ˆã†ãªå£èª¿ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
   - èª­è§£åŠ›ãŒä½ã„ã¨æ±ºã‚ã¤ã‘ã‚‹ã‚ˆã†ãªè¡¨ç¾ã¯é¿ã‘ã¦ã€ã‚ãã¾ã§ã€Œåˆ†ã‹ã‚Šã‚„ã™ãä¼ãˆã‚‹ã€ã“ã¨ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚`;
  } else if (childAge <= 12) {
    // å°å­¦æ ¡é«˜å­¦å¹´
    detailedPrompt = `ã‚ãªãŸã¯ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ©ãƒœã€ã®ãƒ™ãƒ†ãƒ©ãƒ³è§£èª¬å“¡ã§ã™ã€‚ã“ã‚Œã‹ã‚‰ã‚ãªãŸã«ã¯ã€é›£ã—ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ã€çŸ¥çš„å¥½å¥‡å¿ƒæ—ºç››ãªå°å­¦æ ¡é«˜å­¦å¹´ï¼ˆ9-12æ­³ï¼‰ã®æ¢åµå›£å“¡ãŸã¡ã«ã€é¢ç™½ãã€æ·±ãã€ãã—ã¦ç´å¾—ã§ãã‚‹ã‚ˆã†ã«ä¼ãˆã‚‹ãŠä»•äº‹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã€å¤‰æ›ãƒ«ãƒ¼ãƒ«ã€‘
1. **èªå½™ãƒ¬ãƒ™ãƒ«ã¨æ¼¢å­—ã®æ‰±ã„:**
   - å°å­¦æ ¡é«˜å­¦å¹´ã§ç¿’ã†æ¼¢å­—ã¯ç©æ¥µçš„ã«ä½¿ç”¨ã—ã€å¸¸ç”¨æ¼¢å­—ã®ç¯„å›²å†…ã§å¿…è¦ã«å¿œã˜ã¦ç°¡å˜ãªæ¼¢å­—ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
   - å°å­¦æ ¡é«˜å­¦å¹´ã§ç¿’ã‚ãªã„æ¼¢å­—ã‚„ã€èª­ã¿æ–¹ãŒé›£ã—ã„æ¼¢å­—ã«ã¯ã€å¿…ãšæ‹¬å¼§æ›¸ãã§ãµã‚ŠãŒãªï¼ˆã²ã‚‰ãŒãªï¼‰ã‚’æŒ¯ã£ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šæ¦‚å¿µï¼ˆãŒã„ã­ã‚“ï¼‰ã€å½±éŸ¿ï¼ˆãˆã„ãã‚‡ã†ï¼‰ï¼‰
   - æ–°ã—ã„å°‚é–€ç”¨èªãŒå‡ºã¦ããŸå ´åˆã¯ã€ç°¡å˜ãªè¨€è‘‰ã§ã€Œã€œã£ã¦ã€ã“ã†ã„ã†ã“ã¨ãªã‚“ã ã‚ˆã€‚ã€ã®ã‚ˆã†ã«ã€ã‹ã¿ç •ã„ã¦èª¬æ˜ã‚’åŠ ãˆã¦ãã ã•ã„ã€‚

**ã‚¿ã‚¤ãƒˆãƒ«ã®å¤‰æ›ãƒ«ãƒ¼ãƒ«:**
   - ã‚¿ã‚¤ãƒˆãƒ«ã¯å…ƒè¨˜äº‹ã®ä¸»è¦ãªå†…å®¹ã‚„å‡ºæ¥äº‹ã‚’ä¿ã¡ã€å°å­¦æ ¡é«˜å­¦å¹´ãŒç†è§£ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã«ã—ã¦ãã ã•ã„ã€‚
   - ã€Œãªãœï¼Ÿã€ã€Œã©ã†ã—ã¦ï¼Ÿã€ã€Œã™ã”ã„ã“ã¨ãŒèµ·ããŸï¼ã€ãªã©ã®è¡¨ç¾ã‚’ä½¿ã„ãªãŒã‚‰ã€å…ƒã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®è¶£æ—¨ã‚’å¤‰ãˆãªã„ã§ãã ã•ã„ã€‚
   - é›£ã—ã„å°‚é–€ç”¨èªã¯å­ã©ã‚‚ã«ã‚‚ã‚ã‹ã‚‹è¨€è‘‰ã«ç½®ãæ›ãˆã¦ãã ã•ã„ãŒã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®æœ¬è³ªã¯ä¿æŒã—ã¦ãã ã•ã„ã€‚

2. **æ–‡ä½“ã¨å£èª¿:**
   - ã€Œã€œã§ã™ã€‚ã€ã€Œã€œã¾ã™ã€‚ã€èª¿ã‚’åŸºæœ¬ã«ã€æ™‚ã«ã€Œã€œã£ã¦çŸ¥ã£ã¦ã‚‹ã‹ãªï¼Ÿã€ã€Œã˜ã¤ã¯ã­ã€ã“ã‚“ãªç†ç”±ãŒã‚ã‚‹ã‚“ã ã€‚ã€ã®ã‚ˆã†ã«ã€èª­è€…ã®çŸ¥çš„å¥½å¥‡å¿ƒã‚’ãã™ãã‚‹å•ã„ã‹ã‘ã‚„ã€ç§˜å¯†ã‚’æ‰“ã¡æ˜ã‘ã‚‹ã‚ˆã†ãªèªã‚Šå£ã‚’æ··ãœã¦ãã ã•ã„ã€‚
   - è«–ç†çš„ãªã¤ãªãŒã‚Šã‚’æ„è­˜ã—ã¤ã¤ã‚‚ã€å …è‹¦ã—ããªã‚Šã™ããšã€èª­ã¿ã‚„ã™ã„æ–‡ç« ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚

3. **å†…å®¹ã¨èª¬æ˜æ–¹æ³•:**
   - å…ƒã®è¨˜äº‹ã®èƒŒæ™¯ã‚„ã€Œãªãœãã†ãªã‚‹ã®ã‹ã€ã¨ã„ã†ç†ç”±ã‚‚ã€ç°¡æ½”ã«èª¬æ˜ã™ã‚‹ã“ã¨ã§ã€èª­è€…ã®ç†è§£ã‚’æ·±ã‚ã¦ãã ã•ã„ã€‚
   - é›£ã—ã„æ¦‚å¿µã‚„å‡ºæ¥äº‹ã«ã¤ã„ã¦ã¯ã€å›³ã‚„ã‚°ãƒ©ãƒ•ãŒãªãã¦ã‚‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„ã‚ˆã†ã«ã€æ¯”å–©è¡¨ç¾ã‚„å…·ä½“ä¾‹ï¼ˆä¾‹ï¼šå­¦æ ¡ã§ã®å‡ºæ¥äº‹ã€ç¤¾ä¼šç¾è±¡ã€ç§‘å­¦å®Ÿé¨“ãªã©ï¼‰ã‚’åŠ¹æœçš„ã«ä½¿ã£ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
   - ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒè‡ªåˆ†ãŸã¡ã®ç”Ÿæ´»ã‚„æœªæ¥ã«ã©ã†ã¤ãªãŒã‚‹ã®ã‹ã€å°‘ã—ã ã‘ç¤ºå”†ã™ã‚‹ã‚ˆã†ãªè¦–ç‚¹ã‚‚åŠ ãˆã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

4. **é•·ã•ã¨æ§‹æˆ:**
   - å­ã©ã‚‚ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«800æ–‡å­—ä»¥å†…ã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚å…ƒè¨˜äº‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¨èƒŒæ™¯ã‚’é¸ã‚“ã§ã€ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
   - è‡ªç„¶ãªãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®æµã‚Œã§æ›¸ã„ã¦ãã ã•ã„ã€‚ç‰¹åˆ¥ãªè¦‹å‡ºã—ã¯ä¸è¦ã§ã™ã€‚å°å…¥ã€è©³ç´°ã€èƒŒæ™¯ã€ã¾ã¨ã‚ã®æµã‚Œã§ç°¡æ½”ã«æ›¸ã„ã¦ãã ã•ã„ã€‚
   - å„æ®µè½ã¯é©åº¦ãªé•·ã•ã§ã€èª­ã¿ã‚„ã™ã„ã‚ˆã†ã«æ®µè½åˆ†ã‘ã—ã¦ãã ã•ã„ã€‚é‡è¦ãªæƒ…å ±ã«çµã£ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

5. **ç¦æ­¢äº‹é …:**
   - å…ƒè¨˜äº‹ã®å†…å®¹ã‹ã‚‰é€¸è„±ã—ãŸã‚Šã€ä¸æ­£ç¢ºãªæƒ…å ±ã‚’ä¼ãˆãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚
   - å°‚é–€ç”¨èªã‚’èª¬æ˜ãªã—ã«å¤šç”¨ã—ã€èª­è€…ã‚’ç½®ãå»ã‚Šã«ã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
   - å¹¼ã™ãã‚‹è¡¨ç¾ã‚„ã€é€†ã«é›£è§£ã™ãã‚‹è¡¨ç¾ã¯é¿ã‘ã¦ã€ã“ã®å¹´é½¢å±¤ã«ã´ã£ãŸã‚Šã®ãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã£ã¦ãã ã•ã„ã€‚`;
  } else {
    // ä¸­å­¦ç”Ÿ
    detailedPrompt = `ã‚ãªãŸã¯ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ©ãƒœã€ã®ä¸»ä»»ç ”ç©¶å“¡ã§ã™ã€‚ã“ã‚Œã‹ã‚‰ã‚ãªãŸã«ã¯ã€é›£ã—ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ã€ç¤¾ä¼šã‚„æœªæ¥ã«é–¢å¿ƒã®ã‚ã‚‹ä¸­å­¦ç”Ÿï¼ˆ13-15æ­³ï¼‰ã®ãƒ©ãƒœãƒ¡ãƒ³ãƒãƒ¼ãŸã¡ã«ã€æ·±ãè€ƒå¯Ÿã‚’ä¿ƒã—ã€å¤šè§’çš„ãªè¦–ç‚¹ã‚’æä¾›ã™ã‚‹ãŠä»•äº‹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã€å¤‰æ›ãƒ«ãƒ¼ãƒ«ã€‘
1. **èªå½™ãƒ¬ãƒ™ãƒ«ã¨æ¼¢å­—ã®æ‰±ã„:**
   - ä¸­å­¦ç”ŸãŒç†è§£ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã®å¸¸ç”¨æ¼¢å­—ã¯å…¨ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
   - å°‚é–€ç”¨èªã«ã¤ã„ã¦ã¯ã€ãã®æ¦‚å¿µã‚’ç°¡æ½”ã«èª¬æ˜ã—ãŸä¸Šã§ã€å…ƒè¨˜äº‹é€šã‚Šã®è¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚å¿…è¦ã«å¿œã˜ã¦ã€æ‹¬å¼§æ›¸ãã§ã•ã‚‰ã«ç°¡å˜ãªè¨€ã„æ›ãˆã‚’è£œè¶³ã—ã¦ã‚‚è‰¯ã„ã§ã—ã‚‡ã†ã€‚
   - é›£è§£ãªèªå¥ã‚„ç†Ÿèªã«ã¯ã€æ–‡è„ˆã§ç†è§£ã§ãã‚‹ã‚ˆã†é…æ…®ã—ã€å¿…è¦ã§ã‚ã‚Œã°æ³¨é‡ˆã®ã‚ˆã†ã«ç°¡å˜ãªèª¬æ˜ã‚’åŠ ãˆã¦ãã ã•ã„ã€‚

**ã‚¿ã‚¤ãƒˆãƒ«ã®å¤‰æ›ãƒ«ãƒ¼ãƒ«:**
   - ã‚¿ã‚¤ãƒˆãƒ«ã¯å…ƒè¨˜äº‹ã®ä¸»è¦ãªå†…å®¹ã‚„å‡ºæ¥äº‹ã‚’ä¿ã¡ã€ä¸­å­¦ç”ŸãŒé–¢å¿ƒã‚’æŒã¡ç†è§£ã—ã‚„ã™ã„è¡¨ç¾ã«ã—ã¦ãã ã•ã„ã€‚
   - ã€Œãªãœï¼Ÿã€ã€Œã©ã†ã—ã¦ï¼Ÿã€ã€Œã©ã‚“ãªå½±éŸ¿ãŒã‚ã‚‹ï¼Ÿã€ãªã©ã®è¡¨ç¾ã‚’ä½¿ã„ãªãŒã‚‰ã€å…ƒã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®è¶£æ—¨ã‚’å¤‰ãˆãªã„ã§ãã ã•ã„ã€‚
   - é›£ã—ã„å°‚é–€ç”¨èªã¯ã€ä¸­å­¦ç”Ÿã«ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã«ç½®ãæ›ãˆã¦ãã ã•ã„ãŒã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®æœ¬è³ªã¯ä¿æŒã—ã¦ãã ã•ã„ã€‚

2. **æ–‡ä½“ã¨å£èª¿:**
   - ã€Œã€œã§ã‚ã‚‹ã€‚ã€ã€Œã€œã¨è€ƒãˆã‚‹ã€‚ã€ã€Œã€œãŒç¤ºå”†ã•ã‚Œã‚‹ã€‚ã€ã¨ã„ã£ãŸã€è«–ç†çš„ã‹ã¤å®¢è¦³çš„ãªæ–‡ä½“ã‚’åŸºæœ¬ã¨ã—ãªãŒã‚‰ã‚‚ã€èª­è€…ã®æ€è€ƒã‚’åˆºæ¿€ã™ã‚‹ã‚ˆã†ãªå•ã„ã‹ã‘ã‚„ã€è­°è«–ã‚’ä¿ƒã™ã‚ˆã†ãªå£èª¿ã‚’é©åº¦ã«æ··ãœã¦ãã ã•ã„ã€‚
   - èª­è€…ãŒè‡ªèº«ã®æ„è¦‹ã‚’å½¢æˆã™ã‚‹æ‰‹åŠ©ã‘ã¨ãªã‚‹ã‚ˆã†ãªã€å†·é™ã‹ã¤æƒ…å ±ã«åŸºã¥ã„ãŸèªã‚Šå£ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚

3. **å†…å®¹ã¨èª¬æ˜æ–¹æ³•:**
   - å…ƒã®è¨˜äº‹ã®å‡ºæ¥äº‹ã ã‘ã§ãªãã€ãã®èƒŒæ™¯ã«ã‚ã‚‹ç¤¾ä¼šå•é¡Œã€æ­´å²çš„çµŒç·¯ã€é–¢é€£ã™ã‚‹ç§‘å­¦æŠ€è¡“ã‚„çµŒæ¸ˆå‹•å‘ãªã©ã€å¤šè§’çš„ãªè¦–ç‚¹ã‹ã‚‰æƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
   - ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒç¾ä»£ç¤¾ä¼šã‚„è‡ªåˆ†ãŸã¡ã®å°†æ¥ã«ã©ã®ã‚ˆã†ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã‹ã€å…·ä½“çš„ãªäº‹ä¾‹ã‚„ãƒ‡ãƒ¼ã‚¿ï¼ˆå…ƒã®è¨˜äº‹ã«ã‚ã‚Œã°ï¼‰ã‚’å¼•ç”¨ã—ã¤ã¤ã€æ·±ãæ˜ã‚Šä¸‹ã’ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
   - ç‰¹å®šã®äº‹è±¡ã«å¯¾ã™ã‚‹è³›å¦ä¸¡è«–ãŒã‚ã‚‹å ´åˆã¯ã€å…¬å¹³ãªç«‹å ´ã§ãã‚Œãã‚Œã®æ„è¦‹ã‚’ç°¡æ½”ã«ç´¹ä»‹ã—ã€èª­è€…è‡ªèº«ãŒè€ƒãˆã‚‹ãã£ã‹ã‘ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚

4. **é•·ã•ã¨æ§‹æˆ:**
   - ä¸­å­¦ç”ŸãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«800æ–‡å­—ä»¥å†…ã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚å…ƒè¨˜äº‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¨è¤‡æ•°ã®è¦–ç‚¹ã‚’é¸ã‚“ã§ã€ç°¡æ½”ã«åˆ†æã—ã¦ãã ã•ã„ã€‚
   - è‡ªç„¶ãªãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®æµã‚Œã§æ›¸ã„ã¦ãã ã•ã„ã€‚ç‰¹åˆ¥ãªè¦‹å‡ºã—ã¯ä¸è¦ã§ã™ã€‚ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®æ ¸å¿ƒã€èƒŒæ™¯ã€å½±éŸ¿ã€ã¾ã¨ã‚ã®æµã‚Œã§è«–ç†çš„ã«æ›¸ã„ã¦ãã ã•ã„ã€‚
   - å„æ®µè½ã¯å†…å®¹ã®åŒºåˆ‡ã‚Šã‚’æ„è­˜ã—ã€è«–ç†çš„ãªæµã‚ŒãŒæ˜ç¢ºã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚é‡è¦ãªåˆ†æã«çµã£ã¦æƒ…å ±ã‚’å«ã‚ã¦ãã ã•ã„ã€‚

5. **ç¦æ­¢äº‹é …:**
   - å…ƒè¨˜äº‹ã®å†…å®¹ã‚’èª‡å¼µã—ãŸã‚Šã€ç‰¹å®šã®æ„è¦‹ã«åã£ãŸè§£é‡ˆã‚’æŠ¼ã—ä»˜ã‘ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚
   - äº‹å®Ÿã«åŸºã¥ã‹ãªã„æ†¶æ¸¬ã‚„ã€æ ¹æ‹ ã®ãªã„æƒ…å ±ã‚’æç¤ºã—ãªã„ã§ãã ã•ã„ã€‚
   - èª­è€…ã®çŸ¥çš„å¥½å¥‡å¿ƒã‚„è€ƒå¯ŸåŠ›ã‚’è»½è¦–ã™ã‚‹ã‚ˆã†ãªã€å˜ç´”ã™ãã‚‹èª¬æ˜ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
   - å°‚é–€ç”¨èªã‚’èª¬æ˜ãªã—ã«å¤šç”¨ã—ã™ããŸã‚Šã€é€†ã«ç°¡å˜ãªè¨€è‘‰ã«è¨€ã„æ›ãˆã™ãã¦æœ¬è³ªã‚’æãªã£ãŸã‚Šã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚`;
  }

  return `${detailedPrompt}

ã€å…ƒè¨˜äº‹ã€‘
ã‚¿ã‚¤ãƒˆãƒ«: ${article.title}
å†…å®¹: ${article.content}

ã€æœ€é‡è¦æŒ‡ç¤ºã€‘
å­ã©ã‚‚ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«ã€å¤‰æ›å¾Œã®æ–‡ç« ã¯800æ–‡å­—ä»¥å†…ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚å…ƒè¨˜äº‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’é¸ã‚“ã§ã€ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚

ã€è©³ç´°è¦æ±‚ã€‘
- å…ƒè¨˜äº‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠã—ã¦å«ã‚ã‚‹
- å­ã©ã‚‚ã§ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã«ã™ã‚‹
- å¿…è¦ã«å¿œã˜ã¦èƒŒæ™¯æƒ…å ±ã‚’ç°¡æ½”ã«èª¬æ˜
- èº«è¿‘ãªä¾‹ãˆè©±ã‚’ä½¿ã£ã¦ç†è§£ã—ã‚„ã™ãã™ã‚‹
- 800æ–‡å­—ä»¥å†…ã§å®Œçµã«ã¾ã¨ã‚ã‚‹


ã€å‡ºåŠ›å½¢å¼ã€‘
ä»¥ä¸‹ã®å½¢å¼ã§ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å›ç­”ã—ã¦ãã ã•ã„ï¼š

---TITLE---
å¤‰æ›å¾Œã®ã‚¿ã‚¤ãƒˆãƒ«
---CONTENT---
å¤‰æ›å¾Œã®æœ¬æ–‡ï¼ˆæ®µè½ã¯æ”¹è¡Œã§åŒºåˆ‡ã‚‹ã€‚ç‰¹åˆ¥ãªè¦‹å‡ºã—ã¯ä¸è¦ï¼‰
---SUMMARY---
å¤‰æ›å¾Œã®è¦ç´„ï¼ˆ50æ–‡å­—ä»¥å†…ï¼‰
---CATEGORY---
é©åˆ‡ãªã‚«ãƒ†ã‚´ãƒªï¼ˆã‹ãŒãã€ã‚¹ãƒãƒ¼ãƒ„ã€ã›ã„ã˜ã€ã¶ã‚“ã‹ã€ãªã©ï¼‰
`;
}

// è¨˜äº‹ã‚’AIã§å¤‰æ›
export async function convertArticleForChild(
  article: ArticleContent, 
  childAge: number
): Promise<ArticleContent> {
  try {
    // APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œ
    const apiKey = process.env.OPENAI_API_KEY;
    
    console.log('ğŸ” OpenAI APIè¨­å®šãƒã‚§ãƒƒã‚¯:', {
      hasApiKey: !!apiKey,
      keyPrefix: apiKey?.substring(0, 10),
      keyLength: apiKey?.length,
      environment: process.env.NODE_ENV
    });
    
    if (!apiKey || apiKey === 'sk-test-key-placeholder' || apiKey.trim() === '' || !apiKey.startsWith('sk-')) {
      console.log('âš ï¸ OpenAI APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™ã€‚');
      console.log(`ç¾åœ¨ã®APIã‚­ãƒ¼: ${apiKey ? apiKey.substring(0, 10) + '...' : 'undefined'}`);
      return getDemoConversion(article, childAge);
    }

    const prompt = generatePrompt(article, childAge);
    
    console.log('OpenAI APIã§è¨˜äº‹ã‚’å¤‰æ›ä¸­...', { childAge, titleLength: article.title.length });
    
    console.log('ğŸ“ OpenAI API ã¸é€ä¿¡ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé•·:', prompt.length);
    console.log('ğŸ“ å…ƒè¨˜äº‹å†…å®¹é•·:', article.content.length);
    
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: "ã‚ãªãŸã¯å­ä¾›å‘ã‘ãƒ‹ãƒ¥ãƒ¼ã‚¹å¤‰æ›ã®å°‚é–€å®¶ã§ã™ã€‚è¤‡é›‘ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å­ä¾›ã«ã¨ã£ã¦åˆ†ã‹ã‚Šã‚„ã™ãã€èˆˆå‘³æ·±ã„å†…å®¹ã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒå¾—æ„ã§ã™ã€‚ã‚¿ã‚¤ãƒˆãƒ«ã¯å…ƒè¨˜äº‹ã®ä¸»è¦ãªå†…å®¹ã‚„å‡ºæ¥äº‹ã‚’ä¿ã¡ãªãŒã‚‰å­ã©ã‚‚ã®å¹´é½¢ã«é©ã—ãŸè¡¨ç¾ã«å¤‰æ›ã—ã€å­ã©ã‚‚ãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«800æ–‡å­—ä»¥å†…ã§è¦ç‚¹ã‚’ã¾ã¨ã‚ã€è‡ªç„¶ãªãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®æµã‚Œã§ã€ç‰¹åˆ¥ãªè¦‹å‡ºã—ã¯ä½¿ã‚ãšã€é€šå¸¸ã®æ®µè½æ§‹æˆã§æ›¸ã„ã¦ãã ã•ã„ã€‚"
        },
        {
          role: "user", 
          content: prompt
        }
      ],
      max_tokens: 4000, // ã‚ˆã‚Šé•·ã„å›ç­”ã‚’è¨±å¯
      temperature: 0.8
    });
    
    console.log('ğŸ“ OpenAI APIãƒ¬ã‚¹ãƒãƒ³ã‚¹é•·:', completion.choices[0]?.message?.content?.length || 0);

    const response = completion.choices[0]?.message?.content;
    if (!response) {
      throw new Error('OpenAI APIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™');
    }

    // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®å¿œç­”ã‚’ãƒ‘ãƒ¼ã‚¹
    try {
      console.log('ğŸ“ OpenAI APIã‹ã‚‰ã®ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.substring(0, 200) + '...');
      
      // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‚’ãƒ‘ãƒ¼ã‚¹
      const titleMatch = response.match(/---TITLE---\s*([\s\S]*?)\s*---CONTENT---/);
      const contentMatch = response.match(/---CONTENT---\s*([\s\S]*?)\s*---SUMMARY---/);
      const summaryMatch = response.match(/---SUMMARY---\s*([\s\S]*?)\s*---CATEGORY---/);
      const categoryMatch = response.match(/---CATEGORY---\s*([\s\S]*?)$/);
      
      const parsedResponse = {
        convertedTitle: titleMatch ? titleMatch[1].trim() : article.title,
        convertedContent: contentMatch ? contentMatch[1].trim() : article.content,
        convertedSummary: summaryMatch ? summaryMatch[1].trim() : article.summary,
        category: categoryMatch ? categoryMatch[1].trim() : article.category
      };
      
      console.log('ğŸ“ ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', {
        titleLength: parsedResponse.convertedTitle?.length || 0,
        contentLength: parsedResponse.convertedContent?.length || 0,
        summaryLength: parsedResponse.convertedSummary?.length || 0
      });
      
      return {
        title: parsedResponse.convertedTitle,
        content: parsedResponse.convertedContent,
        summary: parsedResponse.convertedSummary,
        category: parsedResponse.category
      };
    } catch (parseError) {
      console.warn('ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚', parseError);
      console.log('ğŸ“ è§£æå¤±æ•—ã—ãŸç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
      // è§£æã«å¤±æ•—ã—ãŸå ´åˆã¯ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“ã‚’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã—ã¦ä½¿ç”¨
      return {
        title: article.title,
        content: response,
        summary: response.substring(0, 50) + '...',
        category: article.category
      };
    }

  } catch (error) {
    console.error('OpenAI API ã‚¨ãƒ©ãƒ¼:', error);
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ¢å¤‰æ›ã‚’ä½¿ç”¨
    console.log('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ã€ãƒ‡ãƒ¢å¤‰æ›ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
    return getDemoConversion(article, childAge);
  }
}

// ãƒ‡ãƒ¢ç”¨ã®å¤‰æ›æ©Ÿèƒ½ï¼ˆOpenAI APIä½¿ç”¨ä¸å¯æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
function getDemoConversion(article: ArticleContent, childAge: number): ArticleContent {
  let convertedTitle = article.title;
  let convertedContent = article.content;
  let convertedSummary = article.summary;
  let category = article.category;

  if (childAge <= 8) {
    // å°å­¦æ ¡ä½å­¦å¹´å‘ã‘
    convertedTitle = convertTitleForYoungKids(article.title);
    convertedContent = convertContentForYoungKids(article.content);
    convertedSummary = convertSummaryForYoungKids(article.summary);
    category = convertCategoryForKids(article.category);
  } else if (childAge <= 12) {
    // å°å­¦æ ¡é«˜å­¦å¹´å‘ã‘
    convertedTitle = convertTitleForOlderKids(article.title);
    convertedContent = convertContentForOlderKids(article.content);
    convertedSummary = convertSummaryForOlderKids(article.summary);
    category = convertCategoryForKids(article.category);
  } else {
    // ä¸­å­¦ç”Ÿå‘ã‘
    convertedTitle = convertTitleForTeens(article.title);
    convertedContent = convertContentForTeens(article.content);
    convertedSummary = convertSummaryForTeens(article.summary);
    category = convertCategoryForKids(article.category);
  }

  return {
    title: convertedTitle,
    content: convertedContent,
    summary: convertedSummary,
    category: category
  };
}

// ãƒ‡ãƒ¢å¤‰æ›ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function convertTitleForYoungKids(title: string): string {
  return title
    .replace(/æ–°ã—ã„/g, 'ã‚ãŸã‚‰ã—ã„')
    .replace(/ç™ºè¦‹/g, 'ã¯ã£ã‘ã‚“')
    .replace(/å®‡å®™/g, 'ã†ã¡ã‚…ã†')
    + ' ã ã‚ˆï¼';
}

function convertContentForYoungKids(content: string): string {
  return content
    .substring(0, 200)
    .replace(/ã§ã™/g, 'ã ã‚ˆ')
    .replace(/ã¾ã™/g, 'ã‚‹ã‚ˆ')
    .replace(/ã€‚/g, 'ï¼\n\n')
    + '\n\nã¨ã¦ã‚‚ ã™ã”ã„ã­ï¼';
}

function convertSummaryForYoungKids(summary: string): string {
  return summary.substring(0, 30) + ' ã™ã”ã„ã­ï¼';
}

function convertTitleForOlderKids(title: string): string {
  return title.replace(/ï¼$/, '') + ' ã«ã¤ã„ã¦çŸ¥ã‚ã†ï¼';
}

function convertContentForOlderKids(content: string): string {
  return content.substring(0, 300) + '\n\nã“ã‚Œã‹ã‚‰ã®ç ”ç©¶ãŒæ¥½ã—ã¿ã§ã™ã­ã€‚';
}

function convertSummaryForOlderKids(summary: string): string {
  return summary.substring(0, 40) + ' èˆˆå‘³æ·±ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™ã€‚';
}

function convertTitleForTeens(title: string): string {
  return title + ' - è©³ç´°è§£èª¬';
}

function convertContentForTeens(content: string): string {
  return content.substring(0, 400) + '\n\nã“ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ç¤¾ä¼šã«ã©ã®ã‚ˆã†ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹ã§ã—ã‚‡ã†ã‹ã€‚';
}

function convertSummaryForTeens(summary: string): string {
  return summary.substring(0, 50) + ' ä»Šå¾Œã®å‹•å‘ã«æ³¨ç›®ã§ã™ã€‚';
}

function convertCategoryForKids(category: string): string {
  const categoryMap: { [key: string]: string } = {
    'ç§‘å­¦': 'ã‹ãŒã',
    'ã‚¹ãƒãƒ¼ãƒ„': 'ã‚¹ãƒãƒ¼ãƒ„',
    'æ”¿æ²»': 'ã›ã„ã˜',
    'çµŒæ¸ˆ': 'ã‘ã„ã–ã„',
    'æ–‡åŒ–': 'ã¶ã‚“ã‹',
    'å›½éš›': 'ã›ã‹ã„',
    'æŠ€è¡“': 'ãã˜ã‚…ã¤',
    'ç’°å¢ƒ': 'ã—ãœã‚“',
    'ç¤¾ä¼š': 'ã—ã‚ƒã‹ã„'
  };
  
  return categoryMap[category] || 'ãã®ä»–';
}